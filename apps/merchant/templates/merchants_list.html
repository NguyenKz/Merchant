<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant List</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.17.0/font/bootstrap-icons.css">
</head>

<body class="bg-light">

    <div class="container mt-5">

        <h1 class="mb-4">Merchant List</h1>

        <!-- Create Button -->
        <button class="btn btn-primary mb-3" onclick="openCreateMerchantModal()">Create Merchant</button>

        <!-- Bootstrap Modal for Create -->
        <div class="modal fade" id="createMerchantModal" tabindex="-1" role="dialog"
            aria-labelledby="createMerchantModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createMerchantModalLabel">Create Merchant</h5>
                        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <label for="create-merchant-name" class="form-label">Name:</label>
                                <input type="text" id="create-merchant-name" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="create-merchant-description" class="form-label">Description:</label>
                                <input type="text" id="create-merchant-description" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="create-merchant-description-html" class="form-label">Description Html:</label>
                                <input type="text" id="create-merchant-description-html" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="create-merchant-email" class="form-label">Email:</label>
                                <input type="email" id="create-merchant-email" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="create-merchant-phone" class="form-label">Phone Number:</label>
                                <input type="text" id="create-merchant-phone" class="form-control">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveCreatedMerchant()">Create</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="errorModalLabel">Error</h5>
                        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close" onclick="closeErrorModal()"></button>
                    </div>
                    <div class="modal-body" id="error-message-body">
                        <!-- Display error message here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="closeErrorModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal fade" id="editMerchantModal" tabindex="-1" role="dialog"
            aria-labelledby="editMerchantModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editMerchantModalLabel">Edit Merchant</h5>
                        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit-merchant-id">
                        <form>
                            <div class="mb-3">
                                <label for="edit-merchant-name" class="form-label">Name:</label>
                                <input type="text" id="edit-merchant-name" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="edit-merchant-description" class="form-label">Description:</label>
                                <input type="text" id="edit-merchant-description" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="edit-merchant-description-html" class="form-label">Description Html:</label>
                                <input type="text" id="edit-merchant-description-html" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="edit-merchant-email" class="form-label">Email:</label>
                                <input type="email" id="edit-merchant-email" class="form-control">
                            </div>
                            <div class="mb-3">
                                <label for="edit-merchant-phone" class="form-label">Phone Number:</label>
                                <input type="text" id="edit-merchant-phone" class="form-control">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveEditedMerchant()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <table class="table table-striped table-bordered mt-3">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Description Html</th>
                    <th>Email</th>
                    <th>Phone Number</th>
                    <th>Created At</th>
                    <th>Updated At</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="merchant-table-body">
            </tbody>
        </table>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    
    <script>
        function openCreateMerchantModal() {
            $('#create-merchant-name').val('');
            $('#create-merchant-description').val('');
            $('#create-merchant-description-html').val('');
            $('#create-merchant-email').val('');
            $('#create-merchant-phone').val('');
            $('#createMerchantModal').modal('show');
        }

        function closeErrorModal() {
            $('#errorModal').modal('hide');
        }
        function saveCreatedMerchant() {
            var newMerchant = {
                name: $('#create-merchant-name').val(),
                description: $('#create-merchant-description').val(),
                description_html: $('#create-merchant-description-html').val(),
                email: $('#create-merchant-email').val(),
                phone_number: $('#create-merchant-phone').val()
            };
            var csrftoken = getCookie('csrftoken');
            $.ajax({
                url: '/merchant/api/',  // Adjust the URL based on your project structure
                method: 'POST',
                data: newMerchant,
                headers: { 'X-CSRFToken': csrftoken },  // Include the CSRF token in the headers
                success: function () {
                    location.reload();
                },
                error: function (error) {
                    console.log('Error creating new merchant:', error.responseJSON);
                    showError(error.responseJSON);
                    

                    
                }
            });
            $('#createMerchantModal').modal('hide');
        }
        var merchants = [];

        function showError(data){
            var msg = "Something was wrong.";
            for (var key in data) {
                msg = data[key];
                break;
            }
            $('#createMerchantModal').modal('hide');
            $('#editMerchantModal').modal('hide');
            $('#error-message-body').text(msg);
            $('#errorModal').modal('show');
        }
        function addNewMerchant() {
            // Switch to edit mode for the new row
            $('#new-merchant-row td.edit-mode').show();
            $('#new-merchant-row td:not(.edit-mode)').hide();
            $('.save-btn, .cancel-btn').show();
            $('button:contains("Add")').hide();
        }

        function saveNewMerchant() {
            var newMerchant = {
                name: $('#new-merchant-name').val(),
                description: $('#new-merchant-description').val(),
                description_html: $('#new-merchant-description-html').val(),
                email: $('#new-merchant-email').val(),
                phone_number: $('#new-merchant-phone').val()
            };

            var csrftoken = getCookie('csrftoken');

            $.ajax({
                url: '/merchant/api/',  // Adjust the URL based on your project structure
                method: 'POST',
                data: newMerchant,
                headers: { 'X-CSRFToken': csrftoken },  // Include the CSRF token in the headers
                success: function () {
                    // If successful, refresh the table
                    location.reload();
                },
                error: function (error) {
                    console.log('Error adding new merchant:', error);
                    showError(error.responseJSON);
                }
            });
        }

        // Function to cancel the edit mode for the new merchant
        function cancelEdit() {
            $('#editMerchantModal').modal('hide');
        }

        // Function to edit an existing merchant
        function editMerchant(merchantId) {
            // Retrieve the existing merchant's data
            var existingMerchant = getMerchantById(merchantId);

            // Populate the modal with the merchant's data
            $('#edit-merchant-id').val(existingMerchant.id);
            $('#edit-merchant-name').val(existingMerchant.name);
            $('#edit-merchant-description').val(existingMerchant.description);
            $('#edit-merchant-description-html').val(existingMerchant.description_html);
            $('#edit-merchant-email').val(existingMerchant.email);
            $('#edit-merchant-phone').val(existingMerchant.phone_number);

            // Show the modal
            $('#editMerchantModal').modal('show');
        }

        // Function to get a merchant by ID from the list
        function getMerchantById(merchantId) {
            // Assuming 'merchants' is the array containing the merchants
            return merchants.find(function (merchant) {
                return merchant.id === merchantId;
            });
        }

        // Function to save changes for the edited merchant
        function saveEditedMerchant() {
            var editedMerchantId = $('#edit-merchant-id').val();
            var editedMerchant = {
                name: $('#edit-merchant-name').val(),
                description: $('#edit-merchant-description').val(),
                description_html: $('#edit-merchant-description-html').val(),
                email: $('#edit-merchant-email').val(),
                phone_number: $('#edit-merchant-phone').val()
            };

            // Get the CSRF token from the cookie
            var csrftoken = getCookie('csrftoken');

            // Make an AJAX request to update the merchant
            $.ajax({
                url: '/merchant/api/' + editedMerchantId + '/',  // Adjust the URL based on your project structure
                method: 'PUT',  // Assuming PUT is used for updating
                data: editedMerchant,
                headers: { 'X-CSRFToken': csrftoken },  // Include the CSRF token in the headers
                success: function () {
                    // If successful, refresh the table
                    location.reload();
                },
                error: function (error) {
                    console.log('Error updating merchant:', error);
                    showError(error.responseJSON);
                }
            });
        }


        // Function to add a new merchant
        function addNewMerchant() {
            var newMerchant = {
                name: $('#new-merchant-name').val(),
                description: $('#new-merchant-description').val(),
                description_html: $('#new-merchant-description-html').val(),
                email: $('#new-merchant-email').val(),
                phone_number: $('#new-merchant-phone').val()
            };

            // Get the CSRF token from the cookie
            var csrftoken = getCookie('csrftoken');

            // Make an AJAX request to add the new merchant
            $.ajax({
                url: '/merchant/api/',  // Adjust the URL based on your project structure
                method: 'POST',
                data: newMerchant,
                headers: { 'X-CSRFToken': csrftoken },  // Include the CSRF token in the headers
                success: function () {
                    // If successful, refresh the table
                    location.reload();
                },
                error: function (error) {
                    console.log('Error adding new merchant:', error);
                    showError(error.responseJSON);
                }
            });
        }

        // When the page is ready
        $(document).ready(function () {
            // Make an AJAX request to the API endpoint
            $.ajax({
                url: '/merchant/api/',  // Adjust the URL based on your project structure
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    // Update the table with merchants
                    updateMerchantTable(data);
                },
                error: function (error) {
                    console.log('Error fetching data:', error);
                    showError(error.responseJSON);
                }
            });
        });

        // Function to update the merchant table
        function updateMerchantTable(_merchants) {
            merchants = _merchants;
            var merchantTableBody = $('#merchant-table-body');
            console.log(merchantTableBody);
            // Clear the existing table rows
            merchantTableBody.empty();
            // Append each merchant as a table row
            merchants.forEach(function (merchant) {
                var tableRow = $('<tr>');
                tableRow.append($('<td>').text(merchant.id));
                tableRow.append($('<td>').text(merchant.name));
                tableRow.append($('<td>').text(merchant.description));
                tableRow.append($('<td>').text(merchant.description_html));
                tableRow.append($('<td>').text(merchant.email));
                tableRow.append($('<td>').text(merchant.phone_number));
                tableRow.append($('<td>').text(merchant.created_at));
                tableRow.append($('<td>').text(merchant.updated_at));

                var editButton = $('<button>').addClass('btn btn-warning btn-sm mx-1').append($('<i>').addClass('fas fa-edit')).click(function () {
                    editMerchant(merchant.id);
                }).append(
                    `<i class="bi bi-pen">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                        <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z"/>
                        </svg>
                        </i>`
                );

                var deleteButton = $('<button>').addClass('btn btn-danger btn-sm').append($('<i>').addClass('fas fa-trash-alt')).click(function () {
                    deleteMerchant(merchant.id);
                }).append(`
                    <i class="bi bi-trash">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                        </svg>
                    </i>`
                );

                tableRow.append($('<td>').append([editButton, deleteButton]));
                merchantTableBody.append(tableRow);
            });
        }

        // Function to handle the delete operation
        function deleteMerchant(merchantId) {
            // Get the CSRF token from the cookie
            var csrftoken = getCookie('csrftoken');

            // Make an AJAX request to delete the merchant
            $.ajax({
                url: '/merchant/api/' + merchantId + '/',  // Adjust the URL based on your project structure
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrftoken },  // Include the CSRF token in the headers
                success: function () {
                    // If successful, refresh the table
                    location.reload();
                },
                error: function (error) {
                    console.log('Error deleting merchant:', error);
                    showError(error.responseJSON);
                }
            });
        }

        // Function to get the CSRF token from the cookie
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Check if the cookie name matches the requested name
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        // Extract and decode the cookie value
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

</body>

</html>
